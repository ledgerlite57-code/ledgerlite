generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  EXPENSE
}

enum AccountSubtype {
  BANK
  CASH
  AR
  AP
  VAT_RECEIVABLE
  VAT_PAYABLE
  SALES
  EXPENSE
  EQUITY
  CUSTOMER_ADVANCES
  VENDOR_PREPAYMENTS
}

enum NormalBalance {
  DEBIT
  CREDIT
}

enum TaxType {
  STANDARD
  ZERO
  EXEMPT
  OUT_OF_SCOPE
}

enum VatBehavior {
  EXCLUSIVE
  INCLUSIVE
}

enum ReportBasis {
  ACCRUAL
  CASH
}

enum DocumentStatus {
  DRAFT
  POSTED
  VOID
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
}

enum PdcDirection {
  INCOMING
  OUTGOING
}

enum PdcStatus {
  DRAFT
  SCHEDULED
  DEPOSITED
  CLEARED
  BOUNCED
  CANCELLED
}

enum GLStatus {
  POSTED
  REVERSED
  VOID
}

enum GLSourceType {
  INVOICE
  BILL
  PAYMENT_RECEIVED
  VENDOR_PAYMENT
  PDC_INCOMING
  PDC_OUTGOING
  EXPENSE
  JOURNAL
  CREDIT_NOTE
}

enum ItemType {
  SERVICE
  INVENTORY
  FIXED_ASSET
  NON_INVENTORY_EXPENSE
}

enum BankTransactionSource {
  IMPORT
  MANUAL
}

enum ReconciliationStatus {
  OPEN
  CLOSED
}

enum ReconciliationMatchType {
  AUTO
  MANUAL
  SPLIT
}

enum InventorySourceType {
  INVOICE
  BILL
  CREDIT_NOTE
  INVOICE_VOID
  BILL_VOID
  CREDIT_NOTE_VOID
  ADJUSTMENT
}

enum AuditAction {
  CREATE
  UPDATE
  POST
  VOID
  DELETE
  LOGIN
  SETTINGS_CHANGE
}

enum InternalRole {
  MANAGER
}

model Organization {
  id                    String              @id @default(uuid())
  name                  String
  legalName             String?
  tradeLicenseNumber    String?
  address               Json?
  phone                 String?
  industryType          String?
  defaultLanguage       String?
  dateFormat            String?
  numberFormat          String?
  countryCode           String?
  baseCurrency          String?
  fiscalYearStartMonth  Int?
  vatEnabled            Boolean             @default(false)
  vatTrn                String?
  timeZone              String?
  createdAt             DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime            @updatedAt @db.Timestamptz(6)

  roles                 Role[]
  memberships           Membership[]
  invites               Invite[]
  accounts              Account[]
  taxCodes              TaxCode[]
  orgSettings           OrgSettings?
  customers             Customer[]
  vendors               Vendor[]
  items                 Item[]
  unitsOfMeasure        UnitOfMeasure[]
  invoices              Invoice[]
  paymentsReceived      PaymentReceived[]
  pdcs                  Pdc[]
  bills                 Bill[]
  expenses              Expense[]
  vendorPayments        VendorPayment[]
  creditNotes           CreditNote[]
  glHeaders             GLHeader[]
  journalEntries        JournalEntry[]
  bankAccounts          BankAccount[]
  bankTransactions      BankTransaction[]
  reconciliationSessions ReconciliationSession[]
  inventoryMovements    InventoryMovement[]
  attachments           Attachment[]
  savedViews            SavedView[]
  auditLogs             AuditLog[]
  idempotencyKeys       IdempotencyKey[]
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  passwordHash  String?
  isActive      Boolean        @default(true)
  isInternal    Boolean        @default(false)
  internalRole  InternalRole?
  lastLoginAt   DateTime?
  createdAt     DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime       @updatedAt @db.Timestamptz(6)

  memberships   Membership[]
  createdInvites Invite[]      @relation("InviteUser")
  auditLogs     AuditLog[]
  refreshTokens RefreshToken[]
  createdInvoices Invoice[]
  createdPaymentsReceived PaymentReceived[]
  createdPdcs   Pdc[]
  createdBills  Bill[]
  createdExpenses Expense[]
  createdVendorPayments VendorPayment[]
  createdCreditNotes CreditNote[]
  createdGLHeaders GLHeader[]
  createdJournalEntries JournalEntry[]
  createdReconciliationSessions ReconciliationSession[]
  createdInventoryMovements InventoryMovement[]
  uploadedAttachments Attachment[]
  savedViews   SavedView[]
}

model Role {
  id         String           @id @default(uuid())
  orgId      String
  name       String
  isSystem   Boolean          @default(false)
  createdAt  DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime         @updatedAt @db.Timestamptz(6)

  org        Organization     @relation(fields: [orgId], references: [id], onDelete: Restrict)
  memberships Membership[]
  rolePermissions RolePermission[]
  invites    Invite[]

  @@unique([orgId, name])
}

model Permission {
  code        String          @id
  description String

  rolePermissions RolePermission[]
}

model RolePermission {
  roleId         String
  permissionCode String

  role           Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission     Permission @relation(fields: [permissionCode], references: [code], onDelete: Cascade)

  @@id([roleId, permissionCode])
}

model Membership {
  id        String     @id @default(uuid())
  orgId     String
  userId    String
  roleId    String
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt DateTime   @updatedAt @db.Timestamptz(6)

  org       Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  user      User         @relation(fields: [userId], references: [id], onDelete: Restrict)
  role      Role         @relation(fields: [roleId], references: [id], onDelete: Restrict)

  @@unique([orgId, userId])
  @@index([orgId, userId])
}

model Invite {
  id         String    @id @default(uuid())
  orgId      String
  email      String
  roleId     String
  tokenHash  String
  expiresAt  DateTime  @db.Timestamptz(6)
  acceptedAt DateTime? @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @db.Timestamptz(6)
  createdByUserId String?

  org        Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  role       Role         @relation(fields: [roleId], references: [id], onDelete: Restrict)
  createdBy  User?        @relation("InviteUser", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@unique([orgId, email, acceptedAt])
}

model OrgSettings {
  orgId              String  @id
  invoicePrefix      String?
  invoiceNextNumber  Int?
  billPrefix         String?
  billNextNumber     Int?
  expensePrefix      String?
  expenseNextNumber  Int?
  paymentPrefix      String?
  paymentNextNumber  Int?
  vendorPaymentPrefix String?
  vendorPaymentNextNumber Int?
  defaultPaymentTerms Int?
  defaultVatBehavior  VatBehavior?
  defaultArAccountId  String?
  defaultApAccountId  String?
  defaultInventoryAccountId String?
  defaultFixedAssetAccountId String?
  defaultCogsAccountId String?
  reportBasis         ReportBasis?
  numberingFormats    Json?
  lockDate           DateTime? @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @db.Timestamptz(6)

  org                Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  defaultArAccount    Account? @relation("OrgSettingsDefaultArAccount", fields: [defaultArAccountId], references: [id], onDelete: SetNull)
  defaultApAccount    Account? @relation("OrgSettingsDefaultApAccount", fields: [defaultApAccountId], references: [id], onDelete: SetNull)
  defaultInventoryAccount Account? @relation("OrgSettingsDefaultInventoryAccount", fields: [defaultInventoryAccountId], references: [id], onDelete: SetNull)
  defaultFixedAssetAccount Account? @relation("OrgSettingsDefaultFixedAssetAccount", fields: [defaultFixedAssetAccountId], references: [id], onDelete: SetNull)
  defaultCogsAccount Account? @relation("OrgSettingsDefaultCogsAccount", fields: [defaultCogsAccountId], references: [id], onDelete: SetNull)
}

model Account {
  id              String        @id @default(uuid())
  orgId           String
  code            String
  name            String
  description     String?
  type            AccountType
  subtype         AccountSubtype?
  parentAccountId String?
  normalBalance   NormalBalance
  isReconcilable  Boolean       @default(false)
  taxCodeId       String?
  externalCode    String?
  tags            Json?
  isSystem        Boolean       @default(false)
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime      @updatedAt @db.Timestamptz(6)

  org                         Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  parentAccount               Account?     @relation("AccountHierarchy", fields: [parentAccountId], references: [id], onDelete: Restrict)
  childAccounts               Account[]    @relation("AccountHierarchy")
  taxCode                     TaxCode?     @relation("AccountTaxCode", fields: [taxCodeId], references: [id], onDelete: SetNull)
  itemsIncome                 Item[]       @relation("IncomeAccount")
  itemsExpense                Item[]       @relation("ExpenseAccount")
  itemsInventory              Item[]       @relation("InventoryAccount")
  itemsFixedAsset             Item[]       @relation("FixedAssetAccount")
  invoiceLineIncomeAccounts   InvoiceLine[] @relation("InvoiceLineIncomeAccount")
  creditNoteLineIncomeAccounts CreditNoteLine[] @relation("CreditNoteLineIncomeAccount")
  billLines                   BillLine[]
  expenseLines                ExpenseLine[]
  glLines                     GLLine[]
  journalLines                JournalLine[]
  bankAccounts                BankAccount[]
  orgSettingsDefaultArAccount OrgSettings[] @relation("OrgSettingsDefaultArAccount")
  orgSettingsDefaultApAccount OrgSettings[] @relation("OrgSettingsDefaultApAccount")
  orgSettingsDefaultInventoryAccount OrgSettings[] @relation("OrgSettingsDefaultInventoryAccount")
  orgSettingsDefaultFixedAssetAccount OrgSettings[] @relation("OrgSettingsDefaultFixedAssetAccount")
  orgSettingsDefaultCogsAccount OrgSettings[] @relation("OrgSettingsDefaultCogsAccount")

  @@unique([orgId, code])
  @@index([orgId, type])
  @@index([orgId, isActive])
  @@index([orgId, parentAccountId])
  @@index([taxCodeId])
}

model TaxCode {
  id        String     @id @default(uuid())
  orgId     String
  name      String
  rate      Decimal    @db.Decimal(5, 2)
  type      TaxType
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt DateTime   @updatedAt @db.Timestamptz(6)

  org          Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  items        Item[]
  invoiceLines InvoiceLine[]
  billLines    BillLine[]
  creditNoteLines CreditNoteLine[]
  expenseLines ExpenseLine[]
  glLines      GLLine[]
  accounts     Account[]    @relation("AccountTaxCode")

  @@unique([orgId, name])
}

model Customer {
  id               String   @id @default(uuid())
  orgId            String
  name             String
  email            String?
  phone            String?
  billingAddress   Json?
  shippingAddress  Json?
  trn              String?
  paymentTermsDays Int      @default(0)
  creditLimit      Decimal? @db.Decimal(18, 2)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @db.Timestamptz(6)

  org      Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  invoices Invoice[]
  creditNotes CreditNote[]
  paymentsReceived PaymentReceived[]
  pdcs     Pdc[]
  glLines  GLLine[]
  journalLines JournalLine[]

  @@index([orgId, name])
}

model Vendor {
  id               String   @id @default(uuid())
  orgId            String
  name             String
  email            String?
  phone            String?
  address          Json?
  trn              String?
  paymentTermsDays Int      @default(0)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @db.Timestamptz(6)

  org      Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  bills    Bill[]
  expenses Expense[]
  vendorPayments VendorPayment[]
  pdcs     Pdc[]
  glLines  GLLine[]
  journalLines JournalLine[]

  @@index([orgId, name])
}

model Item {
  id               String   @id @default(uuid())
  orgId            String
  name             String
  type             ItemType
  sku              String?
  salePrice        Decimal  @db.Decimal(18, 2)
  purchasePrice    Decimal? @db.Decimal(18, 2)
  incomeAccountId  String?
  expenseAccountId String?
  inventoryAccountId String?
  fixedAssetAccountId String?
  defaultTaxCodeId String?
  unitOfMeasureId  String?
  allowFractionalQty Boolean @default(true)
  trackInventory   Boolean  @default(false)
  reorderPoint     Int?
  openingQty       Decimal? @db.Decimal(18, 4)
  openingValue     Decimal? @db.Decimal(18, 2)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @db.Timestamptz(6)

  org              Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  incomeAccount    Account?      @relation("IncomeAccount", fields: [incomeAccountId], references: [id], onDelete: Restrict)
  expenseAccount   Account?      @relation("ExpenseAccount", fields: [expenseAccountId], references: [id], onDelete: Restrict)
  inventoryAccount Account?      @relation("InventoryAccount", fields: [inventoryAccountId], references: [id], onDelete: Restrict)
  fixedAssetAccount Account?     @relation("FixedAssetAccount", fields: [fixedAssetAccountId], references: [id], onDelete: Restrict)
  defaultTaxCode   TaxCode?      @relation(fields: [defaultTaxCodeId], references: [id], onDelete: SetNull)
  unitOfMeasure    UnitOfMeasure? @relation(fields: [unitOfMeasureId], references: [id], onDelete: SetNull)
  invoiceLines     InvoiceLine[]
  billLines        BillLine[]
  creditNoteLines  CreditNoteLine[]
  expenseLines     ExpenseLine[]
  inventoryMovements InventoryMovement[]

  @@index([orgId, name])
  @@index([orgId, sku])
  @@index([unitOfMeasureId])
}

model UnitOfMeasure {
  id             String   @id @default(uuid())
  orgId          String
  name           String
  symbol         String
  baseUnitId     String?
  conversionRate Decimal? @db.Decimal(18, 6)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @db.Timestamptz(6)

  org            Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  baseUnit       UnitOfMeasure? @relation("UomBaseUnit", fields: [baseUnitId], references: [id], onDelete: Restrict)
  derivedUnits   UnitOfMeasure[] @relation("UomBaseUnit")
  items          Item[]
  invoiceLines   InvoiceLine[]
  billLines      BillLine[]
  creditNoteLines CreditNoteLine[]
  expenseLines   ExpenseLine[]

  @@unique([orgId, name])
  @@index([orgId, isActive])
  @@index([baseUnitId])
}

model InventoryMovement {
  id              String   @id @default(uuid())
  orgId           String
  itemId          String
  quantity        Decimal  @db.Decimal(18, 4)
  unitCost        Decimal? @db.Decimal(18, 2)
  sourceType      InventorySourceType
  sourceId        String
  sourceLineId    String?
  createdByUserId String
  createdAt       DateTime @default(now()) @db.Timestamptz(6)

  org             Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  item            Item         @relation(fields: [itemId], references: [id], onDelete: Restrict)
  createdBy       User         @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@index([orgId, itemId])
  @@index([orgId, sourceType, sourceId])
}

model Invoice {
  id            String        @id @default(uuid())
  orgId         String
  number        String?
  status        DocumentStatus @default(DRAFT)
  paymentStatus PaymentStatus @default(UNPAID)
  amountPaid    Decimal       @db.Decimal(18, 2) @default(0)
  customerId    String
  invoiceDate   DateTime      @db.Timestamptz(6)
  dueDate       DateTime      @db.Timestamptz(6)
  currency      String
  exchangeRate  Decimal?      @db.Decimal(18, 6)
  subTotal      Decimal       @db.Decimal(18, 2)
  taxTotal      Decimal       @db.Decimal(18, 2)
  total         Decimal       @db.Decimal(18, 2)
  reference     String?
  notes         String?
  terms         String?
  postedAt      DateTime?     @db.Timestamptz(6)
  voidedAt      DateTime?     @db.Timestamptz(6)
  createdByUserId String
  createdAt     DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime      @updatedAt @db.Timestamptz(6)

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  customer      Customer     @relation(fields: [customerId], references: [id], onDelete: Restrict)
  createdBy     User         @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  lines         InvoiceLine[]
  paymentAllocations PaymentReceivedAllocation[]
  pdcAllocations PdcAllocation[]
  creditNotes   CreditNote[]

  @@unique([orgId, number])
  @@index([orgId, status, invoiceDate])
  @@index([orgId, customerId, invoiceDate])
}

model CreditNote {
  id            String        @id @default(uuid())
  orgId         String
  number        String?
  status        DocumentStatus @default(DRAFT)
  customerId    String
  invoiceId     String?
  creditNoteDate DateTime     @db.Timestamptz(6)
  currency      String
  exchangeRate  Decimal?      @db.Decimal(18, 6)
  subTotal      Decimal       @db.Decimal(18, 2)
  taxTotal      Decimal       @db.Decimal(18, 2)
  total         Decimal       @db.Decimal(18, 2)
  reference     String?
  notes         String?
  postedAt      DateTime?     @db.Timestamptz(6)
  voidedAt      DateTime?     @db.Timestamptz(6)
  createdByUserId String
  createdAt     DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime      @updatedAt @db.Timestamptz(6)

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  customer      Customer     @relation(fields: [customerId], references: [id], onDelete: Restrict)
  invoice       Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  createdBy     User         @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  lines         CreditNoteLine[]

  @@unique([orgId, number])
  @@index([orgId, status, creditNoteDate])
  @@index([orgId, customerId, creditNoteDate])
}

model CreditNoteLine {
  id          String   @id @default(uuid())
  creditNoteId String
  lineNo      Int
  itemId      String?
  unitOfMeasureId String?
  incomeAccountId String?
  description String
  qty         Decimal  @db.Decimal(18, 4)
  unitPrice   Decimal  @db.Decimal(18, 2)
  discountAmount Decimal @db.Decimal(18, 2) @default(0)
  taxCodeId   String?
  lineSubTotal Decimal @db.Decimal(18, 2)
  lineTax     Decimal @db.Decimal(18, 2)
  lineTotal   Decimal @db.Decimal(18, 2)

  creditNote  CreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  item        Item?    @relation(fields: [itemId], references: [id], onDelete: SetNull)
  unitOfMeasure UnitOfMeasure? @relation(fields: [unitOfMeasureId], references: [id], onDelete: SetNull)
  incomeAccount Account? @relation("CreditNoteLineIncomeAccount", fields: [incomeAccountId], references: [id], onDelete: SetNull)
  taxCode     TaxCode? @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)

  @@unique([creditNoteId, lineNo])
  @@index([creditNoteId])
  @@index([unitOfMeasureId])
}

model InvoiceLine {
  id          String   @id @default(uuid())
  invoiceId   String
  lineNo      Int
  itemId      String?
  unitOfMeasureId String?
  incomeAccountId String?
  description String
  qty         Decimal  @db.Decimal(18, 4)
  unitPrice   Decimal  @db.Decimal(18, 2)
  discountAmount Decimal @db.Decimal(18, 2) @default(0)
  taxCodeId   String?
  lineSubTotal Decimal @db.Decimal(18, 2)
  lineTax     Decimal @db.Decimal(18, 2)
  lineTotal   Decimal @db.Decimal(18, 2)

  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  item        Item?    @relation(fields: [itemId], references: [id], onDelete: SetNull)
  unitOfMeasure UnitOfMeasure? @relation(fields: [unitOfMeasureId], references: [id], onDelete: SetNull)
  incomeAccount Account? @relation("InvoiceLineIncomeAccount", fields: [incomeAccountId], references: [id], onDelete: SetNull)
  taxCode     TaxCode? @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)

  @@unique([invoiceId, lineNo])
  @@index([invoiceId])
  @@index([unitOfMeasureId])
}

model PaymentReceived {
  id            String        @id @default(uuid())
  orgId         String
  number        String?
  status        DocumentStatus @default(DRAFT)
  customerId    String
  bankAccountId String?
  paymentDate   DateTime      @db.Timestamptz(6)
  currency      String
  exchangeRate  Decimal?      @db.Decimal(18, 6)
  amountTotal   Decimal       @db.Decimal(18, 2)
  reference     String?
  memo          String?
  postedAt      DateTime?     @db.Timestamptz(6)
  createdByUserId String
  createdAt     DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime      @updatedAt @db.Timestamptz(6)

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  customer      Customer     @relation(fields: [customerId], references: [id], onDelete: Restrict)
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  createdBy     User         @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  allocations   PaymentReceivedAllocation[]

  @@unique([orgId, number])
  @@index([orgId, customerId, paymentDate])
}

model PaymentReceivedAllocation {
  id                String   @id @default(uuid())
  paymentReceivedId String
  invoiceId         String
  amount            Decimal  @db.Decimal(18, 2)

  paymentReceived   PaymentReceived @relation(fields: [paymentReceivedId], references: [id], onDelete: Cascade)
  invoice           Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Restrict)

  @@unique([paymentReceivedId, invoiceId])
  @@index([invoiceId])
}

model Pdc {
  id                String       @id @default(uuid())
  orgId             String
  number            String?
  direction         PdcDirection
  status            PdcStatus    @default(DRAFT)
  customerId        String?
  vendorId          String?
  bankAccountId     String
  chequeNumber      String
  chequeDate        DateTime     @db.Timestamptz(6)
  expectedClearDate DateTime     @db.Timestamptz(6)
  depositedAt       DateTime?    @db.Timestamptz(6)
  clearedAt         DateTime?    @db.Timestamptz(6)
  bouncedAt         DateTime?    @db.Timestamptz(6)
  cancelledAt       DateTime?    @db.Timestamptz(6)
  currency          String
  exchangeRate      Decimal?     @db.Decimal(18, 6)
  amountTotal       Decimal      @db.Decimal(18, 2)
  reference         String?
  memo              String?
  createdByUserId   String
  createdAt         DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime     @updatedAt @db.Timestamptz(6)

  org               Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  customer          Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  vendor            Vendor?      @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  bankAccount       BankAccount  @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  createdBy         User         @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  allocations       PdcAllocation[]

  @@unique([orgId, number])
  @@unique([orgId, direction, bankAccountId, chequeNumber])
  @@index([orgId, status, expectedClearDate])
  @@index([orgId, direction, status])
}

model PdcAllocation {
  id        String   @id @default(uuid())
  pdcId     String
  invoiceId String?
  billId    String?
  amount    Decimal  @db.Decimal(18, 2)

  pdc       Pdc      @relation(fields: [pdcId], references: [id], onDelete: Cascade)
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Restrict)
  bill      Bill?    @relation(fields: [billId], references: [id], onDelete: Restrict)

  @@unique([pdcId, invoiceId])
  @@unique([pdcId, billId])
  @@index([invoiceId])
  @@index([billId])
}

model Bill {
  id            String        @id @default(uuid())
  orgId         String
  vendorId      String
  billNumber    String?
  systemNumber  String?
  status        DocumentStatus @default(DRAFT)
  paymentStatus PaymentStatus @default(UNPAID)
  amountPaid    Decimal       @db.Decimal(18, 2) @default(0)
  billDate      DateTime      @db.Timestamptz(6)
  dueDate       DateTime      @db.Timestamptz(6)
  currency      String
  exchangeRate  Decimal?      @db.Decimal(18, 6)
  subTotal      Decimal       @db.Decimal(18, 2)
  taxTotal      Decimal       @db.Decimal(18, 2)
  total         Decimal       @db.Decimal(18, 2)
  reference     String?
  notes         String?
  postedAt      DateTime?     @db.Timestamptz(6)
  createdByUserId String
  createdAt     DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime      @updatedAt @db.Timestamptz(6)

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  vendor        Vendor       @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  createdBy     User         @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  lines         BillLine[]
  paymentAllocations VendorPaymentAllocation[]
  pdcAllocations PdcAllocation[]

  @@index([orgId, status, billDate])
  @@index([orgId, vendorId, billDate])
  @@unique([orgId, systemNumber])
}

model BillLine {
  id            String   @id @default(uuid())
  billId        String
  lineNo        Int
  expenseAccountId String
  itemId        String?
  unitOfMeasureId String?
  description   String
  qty           Decimal  @db.Decimal(18, 4)
  unitPrice     Decimal  @db.Decimal(18, 2)
  discountAmount Decimal @db.Decimal(18, 2) @default(0)
  taxCodeId     String?
  lineSubTotal  Decimal  @db.Decimal(18, 2)
  lineTax       Decimal  @db.Decimal(18, 2)
  lineTotal     Decimal  @db.Decimal(18, 2)

  bill          Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  expenseAccount Account @relation(fields: [expenseAccountId], references: [id], onDelete: Restrict)
  item          Item?    @relation(fields: [itemId], references: [id], onDelete: SetNull)
  unitOfMeasure UnitOfMeasure? @relation(fields: [unitOfMeasureId], references: [id], onDelete: SetNull)
  taxCode       TaxCode? @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)

  @@unique([billId, lineNo])
  @@index([unitOfMeasureId])
}

model Expense {
  id            String        @id @default(uuid())
  orgId         String
  number        String?
  status        DocumentStatus @default(DRAFT)
  vendorId      String?
  bankAccountId String
  expenseDate   DateTime      @db.Timestamptz(6)
  currency      String
  exchangeRate  Decimal?      @db.Decimal(18, 6)
  subTotal      Decimal       @db.Decimal(18, 2)
  taxTotal      Decimal       @db.Decimal(18, 2)
  total         Decimal       @db.Decimal(18, 2)
  reference     String?
  notes         String?
  postedAt      DateTime?     @db.Timestamptz(6)
  voidedAt      DateTime?     @db.Timestamptz(6)
  createdByUserId String
  createdAt     DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime      @updatedAt @db.Timestamptz(6)

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  vendor        Vendor?      @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  bankAccount   BankAccount  @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  createdBy     User         @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  lines         ExpenseLine[]

  @@unique([orgId, number])
  @@index([orgId, status, expenseDate])
  @@index([orgId, vendorId, expenseDate])
}

model ExpenseLine {
  id            String   @id @default(uuid())
  expenseId     String
  lineNo        Int
  expenseAccountId String
  itemId        String?
  unitOfMeasureId String?
  description   String
  qty           Decimal  @db.Decimal(18, 4)
  unitPrice     Decimal  @db.Decimal(18, 2)
  discountAmount Decimal @db.Decimal(18, 2) @default(0)
  taxCodeId     String?
  lineSubTotal  Decimal  @db.Decimal(18, 2)
  lineTax       Decimal  @db.Decimal(18, 2)
  lineTotal     Decimal  @db.Decimal(18, 2)

  expense       Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  expenseAccount Account @relation(fields: [expenseAccountId], references: [id], onDelete: Restrict)
  item          Item?   @relation(fields: [itemId], references: [id], onDelete: SetNull)
  unitOfMeasure UnitOfMeasure? @relation(fields: [unitOfMeasureId], references: [id], onDelete: SetNull)
  taxCode       TaxCode? @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)

  @@unique([expenseId, lineNo])
  @@index([expenseId])
  @@index([unitOfMeasureId])
}

model VendorPayment {
  id            String        @id @default(uuid())
  orgId         String
  number        String?
  status        DocumentStatus @default(DRAFT)
  vendorId      String
  bankAccountId String?
  paymentDate   DateTime      @db.Timestamptz(6)
  currency      String
  exchangeRate  Decimal?      @db.Decimal(18, 6)
  amountTotal   Decimal       @db.Decimal(18, 2)
  reference     String?
  memo          String?
  postedAt      DateTime?     @db.Timestamptz(6)
  createdByUserId String
  createdAt     DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime      @updatedAt @db.Timestamptz(6)

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  vendor        Vendor       @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  createdBy     User         @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  allocations   VendorPaymentAllocation[]

  @@unique([orgId, number])
}

model VendorPaymentAllocation {
  id              String   @id @default(uuid())
  vendorPaymentId String
  billId          String
  amount          Decimal  @db.Decimal(18, 2)

  vendorPayment   VendorPayment @relation(fields: [vendorPaymentId], references: [id], onDelete: Cascade)
  bill            Bill          @relation(fields: [billId], references: [id], onDelete: Restrict)

  @@unique([vendorPaymentId, billId])
}

model GLHeader {
  id             String      @id @default(uuid())
  orgId          String
  sourceType     GLSourceType
  sourceId       String
  postingDate    DateTime    @db.Timestamptz(6)
  currency       String
  exchangeRate   Decimal?    @db.Decimal(18, 6)
  totalDebit     Decimal     @db.Decimal(18, 2)
  totalCredit    Decimal     @db.Decimal(18, 2)
  status         GLStatus    @default(POSTED)
  reversedByHeaderId String?
  memo           String?
  createdByUserId String
  createdAt      DateTime    @default(now()) @db.Timestamptz(6)

  org            Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  createdBy      User         @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  reversedBy     GLHeader?    @relation("GLReversal", fields: [reversedByHeaderId], references: [id], onDelete: SetNull)
  reversedFrom   GLHeader[]   @relation("GLReversal")
  lines          GLLine[]
  reconciliationMatches ReconciliationMatch[]

  @@unique([orgId, sourceType, sourceId])
  @@index([orgId, postingDate])
  @@index([orgId, sourceType])
}

model GLLine {
  id          String   @id @default(uuid())
  headerId    String
  lineNo      Int
  accountId   String
  debit       Decimal  @db.Decimal(18, 2) @default(0)
  credit      Decimal  @db.Decimal(18, 2) @default(0)
  description String?
  customerId  String?
  vendorId    String?
  taxCodeId   String?

  header      GLHeader @relation(fields: [headerId], references: [id], onDelete: Cascade)
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Restrict)
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  vendor      Vendor?   @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  taxCode     TaxCode?  @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)

  @@unique([headerId, lineNo])
  @@index([accountId])
  @@index([headerId])
  @@index([customerId])
  @@index([vendorId])
}

model JournalEntry {
  id            String        @id @default(uuid())
  orgId         String
  number        String?
  status        DocumentStatus @default(DRAFT)
  journalDate   DateTime      @db.Timestamptz(6)
  memo          String?
  postedAt      DateTime?     @db.Timestamptz(6)
  createdByUserId String
  createdAt     DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime      @updatedAt @db.Timestamptz(6)

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  createdBy     User         @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  lines         JournalLine[]

  @@unique([orgId, number])
}

model JournalLine {
  id            String   @id @default(uuid())
  journalEntryId String
  lineNo        Int
  accountId     String
  debit         Decimal  @db.Decimal(18, 2)
  credit        Decimal  @db.Decimal(18, 2)
  description   String?
  customerId    String?
  vendorId      String?

  journalEntry  JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account       Account      @relation(fields: [accountId], references: [id], onDelete: Restrict)
  customer      Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  vendor        Vendor?      @relation(fields: [vendorId], references: [id], onDelete: SetNull)

  @@unique([journalEntryId, lineNo])
}

model BankAccount {
  id                 String   @id @default(uuid())
  orgId              String
  name               String
  accountNumberMasked String?
  currency           String
  glAccountId        String
  openingBalance     Decimal  @db.Decimal(18, 2) @default(0)
  openingBalanceDate DateTime? @db.Timestamptz(6)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @db.Timestamptz(6)

  org                Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  glAccount          Account      @relation(fields: [glAccountId], references: [id], onDelete: Restrict)
  transactions       BankTransaction[]
  paymentsReceived   PaymentReceived[]
  vendorPayments     VendorPayment[]
  pdcs               Pdc[]
  expenses           Expense[]
  reconciliationSessions ReconciliationSession[]

  @@unique([orgId, name])
}

model BankTransaction {
  id            String   @id @default(uuid())
  orgId         String
  bankAccountId String
  txnDate       DateTime @db.Timestamptz(6)
  description   String
  amount        Decimal  @db.Decimal(18, 2)
  currency      String
  externalRef   String?
  source        BankTransactionSource
  matched       Boolean  @default(false)
  createdAt     DateTime @default(now()) @db.Timestamptz(6)

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  bankAccount   BankAccount  @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  reconciliationMatches ReconciliationMatch[]

  @@unique([orgId, bankAccountId, txnDate, amount, externalRef])
  @@index([orgId, bankAccountId, txnDate])
}

model ReconciliationSession {
  id                      String   @id @default(uuid())
  orgId                   String
  bankAccountId           String
  periodStart             DateTime @db.Timestamptz(6)
  periodEnd               DateTime @db.Timestamptz(6)
  statementOpeningBalance Decimal  @db.Decimal(18, 2)
  statementClosingBalance Decimal  @db.Decimal(18, 2)
  status                  ReconciliationStatus @default(OPEN)
  createdByUserId         String
  createdAt               DateTime @default(now()) @db.Timestamptz(6)
  updatedAt               DateTime @updatedAt @db.Timestamptz(6)

  org                      Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  bankAccount              BankAccount  @relation(fields: [bankAccountId], references: [id], onDelete: Restrict)
  createdBy                User         @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)
  matches                  ReconciliationMatch[]

  @@unique([orgId, bankAccountId, periodStart, periodEnd])
}

model ReconciliationMatch {
  id                       String   @id @default(uuid())
  reconciliationSessionId  String
  bankTransactionId        String
  glHeaderId               String?
  amount                   Decimal  @default(0) @db.Decimal(18, 2)
  matchType                ReconciliationMatchType
  createdAt                DateTime @default(now()) @db.Timestamptz(6)

  session                  ReconciliationSession @relation(fields: [reconciliationSessionId], references: [id], onDelete: Cascade)
  bankTransaction          BankTransaction       @relation(fields: [bankTransactionId], references: [id], onDelete: Restrict)
  glHeader                 GLHeader?             @relation(fields: [glHeaderId], references: [id], onDelete: SetNull)

  @@unique([reconciliationSessionId, bankTransactionId, glHeaderId])
}

model Attachment {
  id              String   @id @default(uuid())
  orgId           String
  entityType      String
  entityId        String
  fileName        String
  mimeType        String
  sizeBytes       Int
  storageKey      String
  description     String?
  uploadedByUserId String
  createdAt       DateTime @default(now()) @db.Timestamptz(6)

  org             Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  uploadedBy      User         @relation(fields: [uploadedByUserId], references: [id], onDelete: Restrict)

  @@index([orgId, entityType, entityId])
}

model SavedView {
  id        String   @id @default(uuid())
  orgId     String
  userId    String
  entityType String
  name      String
  queryJson Json
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  org       Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId, entityType, name])
  @@index([orgId, userId, entityType])
}

model AuditLog {
  id          String     @id @default(uuid())
  orgId       String
  actorUserId String?
  entityType  String
  entityId    String
  action      AuditAction
  before      Json?
  after       Json?
  requestId   String?
  ip          String?
  userAgent   String?
  createdAt   DateTime   @default(now()) @db.Timestamptz(6)

  org         Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)
  actor       User?        @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([orgId, createdAt])
  @@index([orgId, entityType, entityId])
}

model IdempotencyKey {
  id          String   @id @default(uuid())
  orgId       String
  key         String
  requestHash String
  response    Json
  statusCode  Int
  createdAt   DateTime @default(now()) @db.Timestamptz(6)

  org         Organization @relation(fields: [orgId], references: [id], onDelete: Restrict)

  @@unique([orgId, key])
}

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String
  tokenHash  String
  expiresAt  DateTime @db.Timestamptz(6)
  revokedAt  DateTime? @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
